<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Food Order System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body class="bg-light">
    <%- include('_layout/navbar.ejs') %>
    <main class="container mt-5" style="min-width: 80%">
      <div class="content row">
        <div class="col-md-4 table-container">
          <form class="d-flex justify-content-between align-items-center mb-3">
            <input
              type="number"
              class="form-control input-field input-button inputcusID"
              placeholder="Enter CustomerID"
              style="height: 5vh; font-size: 20px; margin-right: 8px"
            />
            <button
              class="btn btn-primary input-button findorders"
              style="height: 5vh; font-size: 20px; margin-bottom: 15px"
            >
              Submit
            </button>
          </form>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>CustomerID</th>
                <th style="width: 70%">Name</th>
              </tr>
            </thead>
            <tbody class="table-customerid"></tbody>
          </table>
        </div>

        <div class="col-md-8 table-container border-left">
          <table class="table table-striped table-bordered table-hover">
            <thead>
              <tr>
                <th class="text-center">OrderID</th>
                <th class="text-center">Total Discount</th>
                <th class="text-center">Total Price</th>
                <th class="text-center">Status</th>
              </tr>
            </thead>
            <tbody class="table-orderswithdiscounts"></tbody>
          </table>
        </div>
      </div>
    </main>

    <script>
      async function getCustomer() {
        try {
          const response = await fetch("http://localhost:3000/api/task2", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          });
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          const { result } = await response.json();
          document.querySelector(".table-customerid").innerHTML = result
            .map(
              (item) =>
                `<tr>
                <td>${item.ID}</td>
                <td>${item.name}</td>
              </tr>
            `
            )
            .join("");
        } catch (err) {
          alert(err.message);
        }
      }
      getCustomer();

      async function getOrdersWithDiscounts(ID) {
        try {
          const response = await fetch(
            `http://localhost:3000/api/task2/${ID}`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          const { result } = await response.json();
          document.querySelector(".table-orderswithdiscounts").innerHTML =
            result
              .map(
                (item) =>
                  `<tr style="font-size:20px">
                    <td class="text-center">${item.OrderID}</td>
                    <td class="text-center">${
                      item.TotalDiscount
                    }</td>  <!-- Đóng thẻ <td> đúng cách -->
                    <td class="text-center">${item.TotalOrderPrice}</td>
                    <td class="text-center" 
                    style="${
                      item.GetStatus === "finished"
                        ? "color: blue;"
                        : "color: yellow;"
                    };  font-weight: bold;">
                    ${item.GetStatus}</td>
                    <td class="text-center"><i class="bi-trash-fill delete-button" style="font-size:20px" data-id="${
                      item.OrderID
                    }"></i></td>

                  </tr>`
              )
              .join("");
          document.querySelectorAll(".delete-button").forEach((button) => {
            button.addEventListener("click", async (e) => {
              e.preventDefault();
              const OrderID = e.target.getAttribute("data-id");
              console.log(OrderID);
              try {
                console.log(1);
                const response = await fetch(
                  `http://localhost:3000/api/task2/${OrderID}`,
                  {
                    method: "DELETE",
                    headers: {
                      "Content-Type": "application/json",
                    },
                  }
                );
                console.log(1);
                if (!response.ok) {
                  throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const res_data = await response.json();
                if (res_data.status === "success") {
                  location.reload();
                } else {
                  alert(res_data.message);
                }
              } catch (err) {
                console.log(err);
                alert(err.message);
              }
            });
          });
        } catch (err) {
          alert(err.message);
        }
      }
      document
        .querySelector(".findorders")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          const ID = document.querySelector(".inputcusID").value;
          await getOrdersWithDiscounts(ID);
        });
    </script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
